/**
 * ========================================
 * MQTT DEBUG TOOL - HÆ°á»›ng dáº«n sá»­ dá»¥ng
 * ========================================
 * 
 * File nÃ y chá»©a hÆ°á»›ng dáº«n cÃ¡ch sá»­ dá»¥ng MQTT Debug Tool
 * Ä‘á»ƒ tÃ¬m vÃ  fix lá»—i MQTT_CONNECT_UNAUTHORIZED (rc=5)
 */

/*
 * CÃCH 1: Debug trong void setup()
 * ================================
 * ThÃªm code sau vÃ o hÃ m setup() trong main.cpp:
 */

// Trong main.cpp, thÃªm include á»Ÿ Ä‘áº§u file:
#include "mqtt_debug.h"

// Trong hÃ m setup(), sau khi setupMQTT(), thÃªm:
void setup() {
    // ... code hiá»‡n táº¡i ...
    
    // Setup MQTT
    setupMQTT();
    
    // ğŸ” DEBUG: Cháº¡y debug tool má»™t láº§n khi khá»Ÿi Ä‘á»™ng
    #ifdef DEBUG_MQTT_ON_STARTUP
    Serial.println("\nğŸ› ï¸  Running MQTT Debug Tool...");
    delay(2000);  // Äá»£i 2 giÃ¢y Ä‘á»ƒ dá»… Ä‘á»c
    MQTTDebugger::debugMQTTConnection(espClient, mqttClient);
    #endif
    
    Serial.println("âœ… System initialized successfully");
}

/*
 * CÃCH 2: Debug thá»§ cÃ´ng qua Serial Command
 * ==========================================
 * ThÃªm command Ä‘á»ƒ cháº¡y debug báº¥t ká»³ lÃºc nÃ o:
 */

void loop() {
    server.handleClient();
    readUARTData();
    
    // ThÃªm Serial command Ä‘á»ƒ debug
    if (Serial.available()) {
        String cmd = Serial.readStringUntil('\n');
        cmd.trim();
        
        if (cmd == "debug" || cmd == "DEBUG") {
            Serial.println("\nğŸ” Running MQTT Debug Tool...");
            MQTTDebugger::debugMQTTConnection(espClient, mqttClient);
        }
    }
    
    // ... pháº§n code cÃ²n láº¡i ...
}

/*
 * CÃCH 3: Tá»± Ä‘á»™ng debug khi reconnect tháº¥t báº¡i
 * =============================================
 * Modify hÃ m reconnectMQTT() Ä‘á»ƒ tá»± Ä‘á»™ng cháº¡y debug sau N láº§n tháº¥t báº¡i:
 */

void reconnectMQTT() {
    static unsigned long lastAttempt = 0;
    static int reconnectAttempts = 0;
    static unsigned long reconnectDelay = MQTT_RECONNECT_DELAY;
    
    if (millis() - lastAttempt < reconnectDelay) {
        return;
    }
    
    lastAttempt = millis();
    
    if (!mqttClient.connected()) {
        reconnectAttempts++;
        Serial.printf("ğŸ”„ MQTT reconnect attempt #%d...\n", reconnectAttempts);
        
        if (mqttClient.connect(MQTT_CLIENT_ID, MQTT_USERNAME, MQTT_PASSWORD)) {
            Serial.println("âœ… MQTT Connected!");
            reconnectAttempts = 0;
            // ... code subscribe ...
        } else {
            int state = mqttClient.state();
            Serial.printf("âŒ MQTT Connection failed, rc=%d\n", state);
            
            // ğŸ” AUTO DEBUG: Cháº¡y debug tool sau 3 láº§n tháº¥t báº¡i
            if (reconnectAttempts == 3) {
                Serial.println("\nâš ï¸  Multiple failures detected. Running diagnostic...\n");
                delay(1000);
                MQTTDebugger::debugMQTTConnection(espClient, mqttClient);
            }
            
            reconnectDelay = min(reconnectDelay * 2, 30000UL);
        }
    }
}

/*
 * ========================================
 * HÆ¯á»šNG DáºªN Sá»¬ Dá»¤NG CHI TIáº¾T
 * ========================================
 * 
 * BÆ¯á»šC 1: ThÃªm #include vÃ o main.cpp
 * -----------------------------------
 * ThÃªm dÃ²ng sau vÃ o Ä‘áº§u file main.cpp (sau cÃ¡c include khÃ¡c):
 * 
 *     #include "mqtt_debug.h"
 * 
 * 
 * BÆ¯á»šC 2: Chá»n má»™t trong 3 cÃ¡ch debug á»Ÿ trÃªn
 * -------------------------------------------
 * - CÃCH 1: Debug tá»± Ä‘á»™ng khi khá»Ÿi Ä‘á»™ng (recommend cho láº§n Ä‘áº§u)
 * - CÃCH 2: Debug thá»§ cÃ´ng qua Serial Monitor
 * - CÃCH 3: Debug tá»± Ä‘á»™ng sau nhiá»u láº§n tháº¥t báº¡i
 * 
 * 
 * BÆ¯á»šC 3: Upload code vÃ  má»Ÿ Serial Monitor
 * -----------------------------------------
 * 1. Upload firmware lÃªn ESP32
 * 2. Má»Ÿ Serial Monitor (115200 baud)
 * 3. Quan sÃ¡t output tá»« debug tool
 * 4. Äá»c cÃ¡c thÃ´ng bÃ¡o lá»—i chi tiáº¿t
 * 5. LÃ m theo hÆ°á»›ng dáº«n sá»­a lá»—i
 * 
 * 
 * ========================================
 * GIáº¢I THÃCH Lá»–I rc=5 (UNAUTHORIZED)
 * ========================================
 * 
 * Lá»—i rc=5 cÃ³ nghÄ©a lÃ  ESP32 ÄÃƒ Káº¾T Ná»I Ä‘Æ°á»£c vá»›i HiveMQ server,
 * nhÆ°ng bá»‹ Tá»ª CHá»I á»§y quyá»n (not authorized). NguyÃªn nhÃ¢n phá»• biáº¿n:
 * 
 * 1. âŒ DUPLICATE Client ID (phá»• biáº¿n nháº¥t!)
 *    â†’ Má»™t device khÃ¡c Ä‘ang dÃ¹ng CÃ™NG Client ID
 *    â†’ HiveMQ chá»‰ cho phÃ©p 1 connection/Client ID
 *    â†’ Fix: Äá»•i MQTT_CLIENT_ID trong hivemq_config.h
 * 
 * 2. âŒ User bá»‹ block hoáº·c disabled
 *    â†’ Kiá»ƒm tra HiveMQ Console â†’ Access Management
 *    â†’ User pháº£i á»Ÿ tráº¡ng thÃ¡i ENABLED
 * 
 * 3. âŒ Thiáº¿u quyá»n (ACL/Permissions)
 *    â†’ User khÃ´ng cÃ³ quyá»n connect vá»›i Client ID nÃ y
 *    â†’ Fix: Cáº¥p quyá»n full (#) trong Access Management
 * 
 * 4. âŒ IP bá»‹ block
 *    â†’ Firewall hoáº·c Rate Limiting
 *    â†’ Kiá»ƒm tra Security Settings
 * 
 * 
 * ========================================
 * QUICK FIX (Thá»­ ngay!)
 * ========================================
 * 
 * 1. VÃ o HiveMQ Console â†’ Clients
 * 2. TÃ¬m Client ID: ESP32_SmartIrrigation_001
 * 3. Náº¿u tháº¥y â†’ Disconnect nÃ³
 * 4. Reset ESP32
 * 
 * HOáº¶C
 * 
 * 1. Má»Ÿ hivemq_config.h
 * 2. Äá»•i dÃ²ng 21:
 *    Tá»«: const char* MQTT_CLIENT_ID = "ESP32_SmartIrrigation_001";
 *    ThÃ nh: const char* MQTT_CLIENT_ID = "ESP32_SmartIrrigation_002";
 * 3. Upload láº¡i firmware
 */
